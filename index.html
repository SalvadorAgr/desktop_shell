<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Shell</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .window-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: transparent;
        }

        .notch-container {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .notch-svg {
            width: 300px;
            height: 20px;
        }

        .canvas-task-container {
            position: absolute;
            top: 35px;
            left: 7px;
            right: 7px;
            bottom: 7px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            transition: gap 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .container-panel-open {
            gap: 4px;
        }

        .main-canvas-wrapper {
            height: 100%;
            flex: 1;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .task-panel-wrapper {
            width: 0;
            height: 100%;
            overflow: hidden;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .container-panel-open .task-panel-wrapper {
            width: 250px;
        }

        .canvas-task-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        .task-panel-svg {
            display: block;
            width: 100%;
            /* Make task panel SVG responsive to its wrapper */
            height: 100%;
        }

        .dock-icon {
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            transform-box: fill-box;
            will-change: transform;
        }

        .dock-icon:hover {
            transform: scale3d(1.167, 1.167, 1);
        }

        .dock-icon-area {
            fill: transparent;
            cursor: pointer;
        }

        /* Functional SplitView Panes (Tier II Elite Implementation) */
        .panes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            grid-template-columns: 1fr 4px 1fr;
            z-index: 5;
            pointer-events: none;
            mask: url(#split-mask);
            -webkit-mask: url(#split-mask);
        }

        .splitview-active .panes-container {
            display: grid;
        }

        .webview-pane {
            pointer-events: auto;
            position: relative;
            overflow: hidden;
            background: transparent;
            border-radius: 5px;
        }

        #splitview-trigger {
            cursor: pointer;
        }

        .canvas-overlay-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 15;
            pointer-events: none;
        }

        .canvas-overlay-svg * {
            pointer-events: auto;
        }

        #splitview-divider {
            cursor: col-resize;
        }

        #divider-handle {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        #splitview-divider.active-handle #divider-handle {
            opacity: 1;
        }

        #splitview-divider.idle #divider-handle {
            opacity: 0.25;
        }

        #splitview-divider:hover #divider-handle {
            opacity: 1 !important;
        }
    </style>
</head>

<body>
    <div class="window-container">
        <div class="notch-container">
            <svg class="notch-svg" width="300" height="20" viewBox="0 0 300 20" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M 0 0 C 12.5 0 12.5 20 25 20 H 275 C 287.5 20 287.5 0 300 0 Z" fill="#0A0A0A" />
            </svg>
        </div>
        <div class="canvas-task-container" id="main-container">
            <div class="main-canvas-wrapper">
                <svg class="canvas-task-svg" viewBox="0 0 1236 658" fill="none" xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="none">
                    <g clip-path="url(#clip0_595_14217)">
                        <path id="main-canvas-path" d="" fill="#0A0A0A" />
                        <defs>
                            <clipPath id="clip0_595_14217">
                                <rect width="100%" height="100%" fill="white" />
                            </clipPath>
                            <mask id="split-mask">
                                <g id="mask-full-group">
                                    <path id="mask-full" d="" fill="white" />
                                </g>
                                <g id="mask-split-group" style="display: none;">
                                    <path id="pane-left-mask-path" d="" fill="white" />
                                    <path id="pane-right-mask-path" d="" fill="white" />
                                </g>
                            </mask>
                            <clipPath id="zipper-clip-split">
                                <rect id="zipper-rect-split" x="0" y="0" width="100%" height="0" />
                            </clipPath>
                            <clipPath id="zipper-clip-full">
                                <rect id="zipper-rect-full" x="0" y="0" width="100%" height="100%" />
                            </clipPath>
                        </defs>
                    </g>
                </svg>

                <svg class="canvas-overlay-svg" viewBox="0 0 1236 658" fill="none" xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="none">
                    <!-- SplitView Separator (Elite Transparency) -->
                    <g id="splitview-divider" style="display: none;">
                        <rect x="-2" y="0" width="11" height="100%" fill="transparent" />
                        <rect id="divider-handle" x="1" y="289.5" width="2" height="50" rx="1" fill="#999999" />
                    </g>

                    <g id="dock-elements">
                        <line x1="539.607" y1="633.107" x2="539.607" y2="652.893" stroke="url(#paint0_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />

                        <!-- Icon 1: SplitView Trigger (Original paths, centered) -->
                        <g class="dock-icon" id="splitview-trigger">
                            <rect class="dock-icon-area" x="555" y="628" width="30" height="30" />
                            <path
                                d="M568.571 648.5H566.339C565.599 648.5 565 647.9 565 647.161V639.125C565 638.385 565.599 637.786 566.339 637.786H568.571"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <path
                                d="M571.429 648.5H573.661C574.4 648.5 575 647.9 575 647.161V639.125C575 638.385 574.4 637.786 573.661 637.786H571.429"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <path d="M570 636V650.286" stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round"
                                fill="none" />
                        </g>

                        <line x1="602.607" y1="633.107" x2="602.607" y2="652.893" stroke="url(#paint1_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />

                        <!-- Icon 2: Home (Original paths, centered) -->
                        <g class="dock-icon">
                            <rect class="dock-icon-area" x="610" y="628" width="30" height="30" />
                            <path
                                d="M619.65 643.242C619.65 642.29 619.65 641.814 619.856 641.396C620.062 640.977 620.448 640.668 621.221 640.048L621.971 639.447C623.369 638.328 624.068 637.768 624.9 637.768C625.732 637.768 626.431 638.328 627.829 639.447L628.579 640.048C629.352 640.668 629.738 640.977 629.944 641.396C630.15 641.814 630.15 642.29 630.15 643.242V646.214C630.15 647.536 630.15 648.197 629.711 648.607C629.271 649.018 628.564 649.018 627.15 649.018H622.65C621.236 649.018 620.529 649.018 620.089 648.607C619.65 648.197 619.65 647.536 619.65 646.214V643.242Z"
                                stroke="#D1D1D1" stroke-width="0.850003" fill="none" />
                            <path
                                d="M626.4 649.018V645.941C626.4 645.569 626.099 645.268 625.727 645.268H624.073C623.701 645.268 623.4 645.569 623.4 645.941V649.018"
                                stroke="#D1D1D1" stroke-width="0.850003" stroke-linecap="round" stroke-linejoin="round"
                                fill="none" />
                        </g>

                        <line x1="649.607" y1="633.107" x2="649.607" y2="652.893" stroke="url(#paint2_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />

                        <!-- Icon 3: Panel Trigger (Original paths, centered) -->
                        <g class="dock-icon" id="panel-trigger">
                            <rect class="dock-icon-area" x="658" y="628" width="30" height="30" />
                            <path
                                d="M672.643 648.643H668.982C668.242 648.643 667.643 648.043 667.643 647.304V638.982C667.643 638.242 668.242 637.643 668.982 637.643H672.643"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <path
                                d="M673.643 648.643H677.304C678.043 648.643 678.643 648.043 678.643 647.304V638.982C678.643 638.242 678.043 637.643 677.304 637.643H673.643"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <rect x="673.5" y="639" width="4" height="8" rx="0.714286" fill="#D1D1D1" />
                        </g>

                        <line x1="696.607" y1="633.107" x2="696.607" y2="652.893" stroke="url(#paint3_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />
                    </g>
                    <defs>
                        <linearGradient id="paint0_linear_595_14217" x1="539" y1="633" x2="539" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                        <linearGradient id="paint1_linear_595_14217" x1="602" y1="633" x2="602" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                        <linearGradient id="paint2_linear_595_14217" x1="649" y1="633" x2="649" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                        <linearGradient id="paint3_linear_595_14217" x1="696" y1="633" x2="696" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="panes-container">
                    <div id="pane-left" class="webview-pane"></div>
                    <div class="spacer"></div>
                    <div id="pane-right" class="webview-pane"></div>
                </div>
            </div>

            <div class="task-panel-wrapper">
                <svg class="task-panel-svg" viewBox="0 0 250 658" fill="none" xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="none">
                    <path id="task-panel-path" d="" fill="transparent" />
                </svg>
            </div>
        </div>

        <script>
            const container = document.getElementById('main-container');
            const trigger = document.getElementById('panel-trigger');
            const splitTrigger = document.getElementById('splitview-trigger');
            const maskFull = document.getElementById('mask-full');
            const maskSplit = document.getElementById('mask-split-views');
            const leftPaneMask = document.getElementById('pane-left-mask-path');
            const rightPaneMask = document.getElementById('pane-right-mask-path');
            const canvasPath = document.getElementById('main-canvas-path');
            const dockElements = document.getElementById('dock-elements');
            const splitDivider = document.getElementById('splitview-divider');
            const wrapper = container.querySelector('.main-canvas-wrapper');
            const taskPanelPath = document.getElementById('task-panel-path');
            const overlaySvg = document.querySelector('.canvas-overlay-svg');
            const panesContainer = document.querySelector('.panes-container');
            const maskSplitGroup = document.getElementById('mask-split-group');
            const zipperRectSplit = document.getElementById('zipper-rect-split');
            const zipperRectFull = document.getElementById('zipper-rect-full');

            let splitRatio = 0.5;
            let isDragging = false;
            let zipperProgress = 0; // 0 to 1
            let isZipperAnimating = false;

            const updateGeometry = () => {
                const w = wrapper.offsetWidth;
                const h = wrapper.offsetHeight;

                const svg = canvasPath.closest('svg');
                svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
                overlaySvg.setAttribute('viewBox', `0 0 ${w} ${h}`);

                const L = 0, R = w;
                const splitX = Math.round(w * splitRatio);
                const rad = 5, bottom = h - 1, dockTop = h - 31, dockCenter = Math.round(w / 2);

                // Dock segments
                const dL = dockCenter - 121, dR = dockCenter + 119;
                const dC1 = dockCenter - 96, dC2 = dockCenter - 71, dC3 = dockCenter + 69, dC4 = dockCenter + 94;

                const fullD = `M ${L + rad} 1 H ${R - rad} Q ${R} 1 ${R} ${1 + rad} V ${bottom - rad} Q ${R} ${bottom} ${R - rad} ${bottom} H ${dR} C ${dC4} ${bottom} ${dC4} ${dockTop} ${dC3} ${dockTop} H ${dC2} C ${dC1} ${dockTop} ${dC1} ${bottom} ${dL} ${bottom} H ${L + rad} Q ${L} ${bottom} ${L} ${bottom - rad} V ${1 + rad} Q ${L} 1 ${L + rad} 1 Z`;

                const leftD = `M ${L + rad} 1 H ${splitX - 2 - rad} Q ${splitX - 2} 1 ${splitX - 2} ${1 + rad} V ${h} H ${L + rad} Q ${L} ${bottom} ${L} ${bottom - rad} V ${1 + rad} Q ${L} 1 ${L + rad} 1 Z`;
                const rightD = `M ${splitX + 2 + rad} 1 H ${R - rad} Q ${R} 1 ${R} ${1 + rad} V ${bottom - rad} Q ${R} ${bottom} ${R - rad} ${bottom} H ${splitX + 2} V ${1 + rad} Q ${splitX + 2} 1 ${splitX + 2 + rad} 1 Z`;

                canvasPath.setAttribute('d', fullD);
                maskFull.setAttribute('d', fullD);
                leftPaneMask.setAttribute('d', leftD);
                rightPaneMask.setAttribute('d', rightD);

                // Update Task Panel Path (250px width)
                const taskH = container.querySelector('.task-panel-wrapper').offsetHeight || 658;
                const taskW = 250;
                const taskRad = 5;
                const taskBottom = taskH - 1;
                const taskD = `M 0 ${taskBottom - taskRad} V ${taskRad} Q 0 1 ${taskRad} 1 H ${taskW - taskRad} Q ${taskW} 1 ${taskW} ${taskRad} V ${taskBottom - taskRad} Q ${taskW} ${taskBottom} ${taskW - taskRad} ${taskBottom} H ${taskRad} Q 0 ${taskBottom} 0 ${taskBottom - taskRad} Z`;
                if (taskPanelPath) taskPanelPath.setAttribute('d', taskD);

                dockElements.setAttribute('transform', `translate(${dockCenter - 618}, ${h - 658})`);
                splitDivider.setAttribute('transform', `translate(${splitX - 2}, 0)`);

                const isActive = container.classList.contains('splitview-active');

                // Zipper logic
                const zipperY = h * zipperProgress;
                maskSplitGroup.style.display = 'block'; // Always block when animating or active

                // Apply clipping to simulate zipper
                document.getElementById('mask-full-group').setAttribute('clip-path', 'url(#zipper-clip-full)');
                maskSplitGroup.setAttribute('clip-path', 'url(#zipper-clip-split)');

                zipperRectSplit.setAttribute('height', zipperY);
                zipperRectFull.setAttribute('y', zipperY);
                zipperRectFull.setAttribute('height', h - zipperY);

                // Divider Logic: Must follow dock shape
                const divHandle = document.getElementById('divider-handle');

                // Determine handle snapping position: follows zipper during animation, then centers
                const targetHandleY = isZipperAnimating ? zipperY - 25 : (h / 2) - 25;
                divHandle.setAttribute('y', Math.max(0, Math.min(h - 50, targetHandleY)));

                if (isActive || isZipperAnimating) {
                    panesContainer.style.display = 'grid';
                    panesContainer.style.gridTemplateColumns = `${splitX - 2}px 4px ${w - splitX - 2}px`;
                    canvasPath.setAttribute('mask', 'url(#split-mask)');
                    resetIdleTimer();
                } else {
                    panesContainer.style.display = 'none';
                    canvasPath.removeAttribute('mask');
                }

                splitDivider.style.display = (isActive || isZipperAnimating) ? 'block' : 'none';
                splitDivider.style.opacity = zipperProgress;
            };

            const startZipperAnimation = (forward) => {
                isZipperAnimating = true;
                const duration = 650; // ms
                const startTime = performance.now();
                const startVal = zipperProgress;
                const endVal = forward ? 1 : 0;

                const step = (now) => {
                    const elapsed = now - startTime;
                    const p = Math.min(elapsed / duration, 1);

                    // Ease out cubic
                    const ease = 1 - Math.pow(1 - p, 3);

                    zipperProgress = startVal + (endVal - startVal) * ease;
                    updateGeometry();

                    if (p < 1) {
                        requestAnimationFrame(step);
                    } else {
                        isZipperAnimating = false;
                        zipperProgress = endVal;
                        updateGeometry();

                        // New Phase: Progressive appearance of the handle
                        if (forward) {
                            splitDivider.classList.add('active-handle');
                        } else {
                            splitDivider.classList.remove('active-handle');
                        }
                    }
                };

                if (!forward) {
                    splitDivider.classList.remove('active-handle');
                }
                requestAnimationFrame(step);
            };

            let idleTimer;
            const resetIdleTimer = () => {
                if (!splitDivider) return;
                splitDivider.classList.remove('idle');
                clearTimeout(idleTimer);
                idleTimer = setTimeout(() => {
                    if (!isDragging) {
                        splitDivider.classList.add('idle');
                    }
                }, 5000); // 5 seconds
            };

            window.addEventListener('mousemove', resetIdleTimer);
            window.addEventListener('mousedown', resetIdleTimer);

            const onMouseMove = (e) => {
                if (!isDragging) return;
                const rect = wrapper.getBoundingClientRect();
                let x = e.clientX - rect.left;

                // Constraints: 250px min per pane
                const minSide = 250;
                if (x < minSide) x = minSide;
                if (x > rect.width - minSide) x = rect.width - minSide;

                // Magnetic Snap Points (Tier Elite implementation)
                const snapThreshold = 8;
                const centerX = rect.width / 2;
                const snapPoints = [
                    minSide,                // Left lateral stop
                    rect.width * 0.25,     // Left pane midpoint
                    centerX,                // Main center
                    rect.width * 0.75,     // Right pane midpoint
                    rect.width - minSide    // Right lateral stop
                ];

                for (const p of snapPoints) {
                    if (Math.abs(x - p) < snapThreshold) {
                        x = p;
                        break;
                    }
                }

                splitRatio = x / rect.width;
                updateGeometry();
            };

            const onMouseUp = () => {
                isDragging = false;
                document.body.style.cursor = 'default';
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            };

            splitDivider.addEventListener('mousedown', (e) => {
                isDragging = true;
                document.body.style.cursor = 'col-resize';
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
                e.preventDefault();
            });

            const resizeObserver = new ResizeObserver(() => {
                updateGeometry();
            });
            resizeObserver.observe(wrapper);

            // Initial alignment
            updateGeometry();

            trigger.addEventListener('click', () => {
                container.classList.toggle('container-panel-open');
                // Allow transition to finish then update geometry (or observer will handle it)
            });

            splitTrigger.addEventListener('click', () => {
                const becomingActive = !container.classList.contains('splitview-active');
                container.classList.toggle('splitview-active');
                startZipperAnimation(becomingActive);
            });
        </script>
    </div>
</body>

</html>