<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Shell</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .window-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: transparent;
            -webkit-app-region: drag;
        }

        .notch-container {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            -webkit-app-region: no-drag;
        }

        .notch-svg {
            width: 300px;
            height: 20px;
        }

        .canvas-task-container {
            position: absolute;
            top: 30px;
            left: 7px;
            right: 7px;
            bottom: 7px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            transition: gap 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-app-region: no-drag;
        }

        .container-panel-open {
            gap: 4px;
        }

        .main-canvas-wrapper {
            height: 100%;
            flex: 1;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .task-panel-wrapper {
            width: 0;
            height: 100%;
            overflow: hidden;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            flex-shrink: 0;
            will-change: width;
            transform: translateZ(0);
            /* Force GPU layer */
            backface-visibility: hidden;
        }

        .container-panel-open .task-panel-wrapper {
            width: 300px;
        }

        .canvas-task-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        .task-panel-svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .dock-icon {
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            transform-box: fill-box;
            will-change: transform;
        }

        .dock-icon:hover {
            transform: scale3d(1.167, 1.167, 1);
        }

        .dock-icon-area {
            fill: transparent;
            cursor: pointer;
            pointer-events: auto;
        }

        #dock-hit-area {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            bottom: 0;
            height: 15px;
            z-index: 1200;
            pointer-events: auto;
            background: transparent;
            cursor: default;
        }

        #dock-elements {
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1150;
        }

        #dock-elements .dock-icon {
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-grid {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 250px;
            z-index: 2;
            padding-bottom: 20px;
        }

        .app-icon {
            width: 100%;
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Bouncy pop */
        }

        .app-icon:hover {
            transform: scale(1.1);
        }

        .app-icon:active {
            transform: scale(0.95);
        }

        #dock-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 900;
            background: transparent;
            display: none;
            pointer-events: auto;
            cursor: default;
        }

        .panes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 0px 0px;
            z-index: 5;
            pointer-events: none;
            mask: url(#split-mask);
            -webkit-mask: url(#split-mask);
        }

        .splitview-active .panes-container {
            display: grid;
        }

        .spacer {
            background: transparent;
            pointer-events: none;
        }

        .webview-pane {
            pointer-events: auto;
            position: relative;
            overflow: hidden;
            background: #ffffff;
            /* Fix: Ensure page background is white */
            border-radius: 10px;
        }

        .webview-pane webview {
            width: 100%;
            height: 100%;
            border: none;
            background: #ffffff;
        }

        #splitview-trigger {
            cursor: pointer;
        }

        .canvas-overlay-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 1100;
            pointer-events: none;
        }

        .canvas-overlay-svg * {
            pointer-events: auto;
        }

        #splitview-divider {
            cursor: col-resize;
        }

        #divider-handle {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        #splitview-divider.active-handle #divider-handle {
            opacity: 1;
        }

        #splitview-divider.idle #divider-handle {
            opacity: 0.25;
        }

        #splitview-divider:hover #divider-handle {
            opacity: 1 !important;
        }

        /* Prevent webviews from capturing mouse events during resize */
        body.is-resizing webview {
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="window-container">
        <div id="dock-backdrop"></div>
        <div class="notch-container">
            <svg class="notch-svg" width="300" height="20" viewBox="0 0 300 20" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M 0 0 C 12.5 0 12.5 20 25 20 H 275 C 287.5 20 287.5 0 300 0 Z" fill="#0A0A0A" />
            </svg>
        </div>
        <div class="canvas-task-container" id="main-container">
            <div class="main-canvas-wrapper">
                <div id="dock-hit-area"></div>
                <svg class="canvas-task-svg" viewBox="0 0 1386 663" fill="none" xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="none">
                    <g clip-path="url(#clip0_595_14217)">
                        <path id="main-canvas-path" d="" fill="#0A0A0A" />
                        <defs>
                            <clipPath id="clip0_595_14217">
                                <rect width="100%" height="100%" fill="white" />
                            </clipPath>
                            <mask id="split-mask">
                                <g id="mask-full-group">
                                    <path id="mask-full" d="" fill="white" />
                                </g>
                                <g id="mask-split-group" style="display: none;">
                                    <path id="pane-left-mask-path" d="" fill="white" />
                                    <path id="pane-right-mask-path" d="" fill="white" />
                                </g>
                            </mask>
                            <clipPath id="zipper-clip-split">
                                <rect id="zipper-rect-split" x="0" y="0" width="100%" height="0" />
                            </clipPath>
                            <clipPath id="zipper-clip-full">
                                <rect id="zipper-rect-full" x="0" y="0" width="100%" height="100%" />
                            </clipPath>
                        </defs>
                    </g>
                </svg>

                <svg class="canvas-overlay-svg" viewBox="0 0 1386 663" fill="none" xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="none">
                    <!-- SplitView Separator -->
                    <g id="splitview-divider" style="display: none;">
                        <rect x="-2" y="0" width="11" height="100%" fill="transparent" />
                        <rect id="divider-handle" x="1" y="289.5" width="2" height="50" rx="1" fill="#999999" />
                    </g>

                    <g id="dock-elements">
                        <!-- Left Separator -->
                        <line x1="537" y1="633.107" x2="537" y2="652.893" stroke="url(#paint0_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />

                        <!-- Icon 1: SplitView Trigger (Center 564, gap 12px) -->
                        <g class="dock-icon" id="splitview-trigger">
                            <rect class="dock-icon-area" x="549" y="628" width="30" height="30" />
                            <path
                                d="M562.571 648.5H560.339C559.599 648.5 559 647.9 559 647.161V639.125C559 638.385 559.599 637.786 560.339 637.786H562.571"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <path
                                d="M565.429 648.5H567.661C568.4 648.5 569 647.9 569 647.161V639.125C569 638.385 568.4 637.786 567.661 637.786H565.429"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <path d="M564 636V650.286" stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round"
                                fill="none" />
                        </g>

                        <!-- Mid-Left Separator -->
                        <line x1="591" y1="633.107" x2="591" y2="652.893" stroke="url(#paint1_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />

                        <!-- Icon 2: Home (Center 618, gap 12px) -->
                        <g class="dock-icon">
                            <rect class="dock-icon-area" x="603" y="628" width="30" height="30" />
                            <path
                                d="M612.65 643.242C612.65 642.29 612.65 641.814 612.856 641.396C613.062 640.977 613.448 640.668 614.221 640.048L614.971 639.447C616.369 638.328 617.068 637.768 617.9 637.768C618.732 637.768 619.431 638.328 620.829 639.447L621.579 640.048C622.352 640.668 622.738 640.977 622.944 641.396C623.15 641.814 623.15 642.29 623.15 643.242V646.214C623.15 647.536 623.15 648.197 622.711 648.607C622.271 649.018 621.564 649.018 620.15 649.018H615.65C614.236 649.018 613.529 649.018 613.089 648.607C612.65 648.197 612.65 647.536 612.65 646.214V643.242Z"
                                stroke="#D1D1D1" stroke-width="0.850003" fill="none" />
                            <path
                                d="M619.4 649.018V645.941C619.4 645.569 619.099 645.268 618.727 645.268H617.073C616.701 645.268 616.4 645.569 616.4 645.941V649.018"
                                stroke="#D1D1D1" stroke-width="0.850003" stroke-linecap="round" stroke-linejoin="round"
                                fill="none" />
                        </g>

                        <!-- Mid-Right Separator -->
                        <line x1="645" y1="633.107" x2="645" y2="652.893" stroke="url(#paint2_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />

                        <!-- Icon 3: Panel Trigger (Center 672, gap 12px) -->
                        <g class="dock-icon" id="panel-trigger">
                            <rect class="dock-icon-area" x="657" y="628" width="30" height="30" />
                            <path
                                d="M671.643 648.643H667.982C667.242 648.643 666.643 648.043 666.643 647.304V638.982C666.643 638.242 667.242 637.643 667.982 637.643H671.643"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <path
                                d="M672.643 648.643H676.304C677.043 648.643 677.643 648.043 677.643 647.304V638.982C677.643 638.242 677.043 637.643 676.304 637.643H672.643"
                                stroke="#D1D1D1" stroke-width="0.714286" stroke-linecap="round" fill="none" />
                            <rect x="672.5" y="639" width="4" height="8" rx="0.714286" fill="#D1D1D1" />
                        </g>

                        <!-- Right Separator -->
                        <line x1="699" y1="633.107" x2="699" y2="652.893" stroke="url(#paint3_linear_595_14217)"
                            stroke-width="0.214453" stroke-linecap="round" />
                    </g>
                    <defs>
                        <linearGradient id="paint0_linear_595_14217" x1="539" y1="633" x2="539" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                        <linearGradient id="paint1_linear_595_14217" x1="602" y1="633" x2="602" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                        <linearGradient id="paint2_linear_595_14217" x1="649" y1="633" x2="649" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                        <linearGradient id="paint3_linear_595_14217" x1="696" y1="633" x2="696" y2="653"
                            gradientUnits="userSpaceOnUse">
                            <stop stop-color="white" stop-opacity="0" />
                            <stop offset="0.480769" stop-color="#CACACA" />
                            <stop offset="1" stop-color="#999999" stop-opacity="0" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="panes-container">
                    <div id="pane-left" class="webview-pane">
                        <webview id="wv-left" src="http://localhost:3001" allowpopups
                            useragent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36">
                        </webview>
                    </div>
                    <div class="spacer"></div>
                    <div id="pane-right" class="webview-pane">
                        <!-- Content injected via JS -->
                    </div>
                </div>
            </div>

            <div class="task-panel-wrapper" style="position: relative;">
                <img src="assets/svg/panel_apps/content.svg"
                    style="width: 300px; height: 100%; flex-shrink: 0; display: block;" alt="Task Panel Background" />
                <img src="assets/svg/panel_apps/pestañas.svg"
                    style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 250px; height: 20px; z-index: 2;"
                    alt="Panel Tabs" />
                <img src="assets/svg/panel_apps/line.svg"
                    style="position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 221px; height: 9px; z-index: 2;"
                    alt="Panel Divider" />
                <img src="assets/svg/panel_apps/search.svg"
                    style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%); width: 250px; height: 20px; z-index: 2;"
                    alt="Search Bar" />
            </div>
        </div>

        <script>

            const container = document.getElementById('main-container');
            const trigger = document.getElementById('panel-trigger');
            const splitTrigger = document.getElementById('splitview-trigger');
            const maskFull = document.getElementById('mask-full');
            const leftPaneMask = document.getElementById('pane-left-mask-path');
            const rightPaneMask = document.getElementById('pane-right-mask-path');
            const canvasPath = document.getElementById('main-canvas-path');
            const dockElements = document.getElementById('dock-elements');
            const splitDivider = document.getElementById('splitview-divider');
            const wrapper = container.querySelector('.main-canvas-wrapper');
            const taskPanelPath = document.getElementById('task-panel-path');
            const overlaySvg = document.querySelector('.canvas-overlay-svg');
            const panesContainer = document.querySelector('.panes-container');
            const maskSplitGroup = document.getElementById('mask-split-group');
            const zipperRectSplit = document.getElementById('zipper-rect-split');
            const zipperRectFull = document.getElementById('zipper-rect-full');

            let splitRatio = 1.0;
            let viewMode = 'single-left';

            let dockState = 'closed';
            let cachedW = 0, cachedH = 0;
            let lastPaths = { fullD: '', leftD: '', rightD: '', taskD: '', splitX: -1, splitRatio: -1 };
            let isLooping = false;
            let isDragging = false;
            let splitRatioAnimationActive = false;

            const MODERN_UA = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36";

            const K_CENTER = 0.05;
            const K_LATERAL = 0.025;
            const DAMPING = 0.35;
            const DT = 1.0;

            const particles = {
                dL: { x: 0, y: 700, py: 700, k: K_LATERAL, ty: 0 },
                dR: { x: 0, y: 700, py: 700, k: K_LATERAL, ty: 0 },
                dC1: { x: 0, y: 700, py: 700, k: K_LATERAL * 1.5, ty: 0 },
                dC2: { x: 0, y: 700, py: 700, k: K_CENTER, ty: 0 },
                dC3: { x: 0, y: 700, py: 700, k: K_CENTER, ty: 0 },
                dC4: { x: 0, y: 700, py: 700, k: K_LATERAL * 1.5, ty: 0 }
            };

            const initParticles = (w, h) => {
                cachedW = w; cachedH = h;
                const bottom = h - 1;
                const dockTop = h - 26;
                particles.dL.y = particles.dL.py = bottom; particles.dL.ty = bottom;
                particles.dR.y = particles.dR.py = bottom; particles.dR.ty = bottom;
                particles.dC1.y = particles.dC1.py = bottom; particles.dC1.ty = bottom;
                particles.dC2.y = particles.dC2.py = bottom; particles.dC2.ty = dockTop;
                particles.dC3.y = particles.dC3.py = bottom; particles.dC3.ty = dockTop;
                particles.dC4.y = particles.dC4.py = bottom; particles.dC4.ty = bottom;
                startLoop();
            };

            const updatePhysics = (h) => {
                if (!h) return false;
                const bottom = h - 1;
                const isClosed = (dockState === 'closed');
                let moving = false;
                const progress = (bottom - particles.dC2.y) / 25;
                const centerVis = Math.max(0, (progress - 0.82) / 0.18);
                const edgeVis = Math.max(0, (progress - 0.95) / 0.05);
                const icons = dockElements.querySelectorAll('.dock-icon');
                const lines = dockElements.querySelectorAll('line');
                icons.forEach((icon, idx) => {
                    const isCenter = (idx === 1);
                    const v = isCenter ? centerVis : edgeVis;
                    icon.style.opacity = Math.pow(v, 2);
                    icon.style.pointerEvents = (v > 0.5) ? 'auto' : 'none';
                });
                lines.forEach(line => { line.style.opacity = Math.pow(edgeVis, 2); });
                for (let key in particles) {
                    const p = particles[key];
                    const targetY = isClosed ? bottom : p.ty;
                    const force = (targetY - p.y) * p.k;
                    const velocity = (p.y - p.py) * DAMPING;
                    const nextY = p.y + velocity + force * (DT * DT);
                    if (Math.abs(nextY - p.y) > 0.001 || Math.abs(targetY - nextY) > 0.001) moving = true;
                    p.py = p.y; p.y = nextY;
                }
                return moving;
            };

            const updateGeometry = () => {
                const w = cachedW; const h = cachedH;
                if (!w || !h) return;
                const svg = canvasPath.closest('svg');
                const viewBoxStr = `0 0 ${w} ${h}`;
                if (svg.getAttribute('viewBox') !== viewBoxStr) {
                    svg.setAttribute('viewBox', viewBoxStr);
                    overlaySvg.setAttribute('viewBox', viewBoxStr);
                }
                const L = 0, R = w, rad = 10, bottom = h - 1;
                let splitX = Math.round(w * splitRatio);
                splitX = Math.max(0, Math.min(w, splitX));
                const p = particles; const dockCenter = Math.round(w / 2);
                p.dL.x = dockCenter - 121; p.dR.x = dockCenter + 119;
                p.dC1.x = dockCenter - 96; p.dC2.x = dockCenter - 71;
                p.dC3.x = dockCenter + 69; p.dC4.x = dockCenter + 94;
                const fullD = `M ${L + rad} 1 H ${R - rad} Q ${R} 1 ${R} ${1 + rad} V ${bottom - rad} Q ${R} ${bottom} ${R - rad} ${bottom} H ${p.dR.x} C ${p.dC4.x} ${bottom} ${p.dC4.x} ${p.dC3.y} ${p.dC3.x} ${p.dC3.y} H ${p.dC2.x} C ${p.dC1.x} ${p.dC2.y} ${p.dC1.x} ${bottom} ${p.dL.x} ${bottom} H ${L + rad} Q ${L} ${bottom} ${L} ${bottom - rad} V ${1 + rad} Q ${L} 1 ${L + rad} 1 Z`;
                const leftD = `M ${L + rad} 1 H ${splitX - 2 - rad} Q ${splitX - 2} 1 ${splitX - 2} ${1 + rad} V ${p.dC2.y} H ${p.dC2.x} C ${p.dC1.x} ${p.dC2.y} ${p.dC1.x} ${bottom} ${p.dL.x} ${bottom} H ${L + rad} Q ${L} ${bottom} ${L} ${bottom - rad} V ${1 + rad} Q ${L} 1 ${L + rad} 1 Z`;
                const rightD = `M ${splitX + 2 + rad} 1 H ${R - rad} Q ${R} 1 ${R} ${1 + rad} V ${bottom - rad} Q ${R} ${bottom} ${R - rad} ${bottom} H ${p.dR.x} C ${p.dC4.x} ${bottom} ${p.dC4.x} ${p.dC3.y} ${p.dC3.x} ${p.dC3.y} H ${splitX + 2} V ${1 + rad} Q ${splitX + 2} 1 ${splitX + 2 + rad} 1 Z`;
                if (fullD !== lastPaths.fullD) { canvasPath.setAttribute('d', fullD); maskFull.setAttribute('d', fullD); lastPaths.fullD = fullD; }
                if (leftD !== lastPaths.leftD) { leftPaneMask.setAttribute('d', leftD); lastPaths.leftD = leftD; }
                if (rightD !== lastPaths.rightD) { rightPaneMask.setAttribute('d', rightD); lastPaths.rightD = rightD; }
                const taskWrapper = container.querySelector('.task-panel-wrapper');
                if (taskWrapper.offsetWidth > 1) {
                    const taskH = taskWrapper.offsetHeight || 663;
                    const taskW = 300, taskRad = 10, taskBottom = taskH - 1;
                    const taskD = `M 0 ${taskBottom - taskRad} V ${taskRad} Q 0 1 ${taskRad} 1 H ${taskW - taskRad} Q ${taskW} 1 ${taskW} ${taskRad} V ${taskBottom - taskRad} Q ${taskW} ${taskBottom} ${taskW - taskRad} ${taskBottom} H ${taskRad} Q 0 ${taskBottom} 0 ${taskBottom - taskRad} Z`;
                    if (taskPanelPath && taskD !== lastPaths.taskD) { taskPanelPath.setAttribute('d', taskD); lastPaths.taskD = taskD; }
                }
                dockElements.setAttribute('transform', `translate(${dockCenter - 618}, ${h - 656.5})`);
                splitDivider.style.transform = `translate(${splitX - 2}px, 0)`;
                if (splitRatio !== lastPaths.splitRatio || splitX !== lastPaths.splitX) {
                    if (splitRatio >= 0.99) { panesContainer.style.gridTemplateColumns = `1fr 0px 0px`; splitDivider.style.display = 'none'; }
                    else if (splitRatio <= 0.01) { panesContainer.style.gridTemplateColumns = `0px 0px 1fr`; splitDivider.style.display = 'none'; }
                    else { panesContainer.style.gridTemplateColumns = `${splitX - 2}px 4px ${w - splitX - 2}px`; splitDivider.style.display = 'block'; }
                    const maskFullGrp = document.getElementById('mask-full-group');
                    const maskSplitGrp = document.getElementById('mask-split-group');
                    if (splitRatio > 0.99 || splitRatio < 0.01) { maskFullGrp.style.display = 'block'; maskSplitGrp.style.display = 'none'; }
                    else { maskFullGrp.style.display = 'none'; maskSplitGrp.style.display = 'block'; }
                    lastPaths.splitRatio = splitRatio; lastPaths.splitX = splitX;
                }
                zipperRectSplit.setAttribute('height', '100%'); zipperRectFull.setAttribute('height', '100%');
                zipperRectFull.setAttribute('y', '0'); canvasPath.setAttribute('mask', 'url(#split-mask)');
            };

            const animate = () => {
                const moving = updatePhysics(cachedH);
                updateGeometry();
                if (moving || splitRatioAnimationActive || isDragging) { requestAnimationFrame(animate); }
                else { isLooping = false; }
            };

            const startLoop = () => { if (!isLooping) { isLooping = true; requestAnimationFrame(animate); } };

            const onResize = () => {
                cachedW = wrapper.offsetWidth; cachedH = wrapper.offsetHeight;
                updateGeometry(); startLoop();
            };
            const rObs = new ResizeObserver(onResize);
            rObs.observe(wrapper); rObs.observe(container.querySelector('.task-panel-wrapper'));

            const hitArea = document.getElementById('dock-hit-area');
            const backdrop = document.getElementById('dock-backdrop');
            hitArea.addEventListener('mouseenter', () => {
                if (dockState === 'closed') {
                    dockState = 'open'; hitArea.style.pointerEvents = 'none';
                    backdrop.style.display = 'block'; startLoop();
                }
            });

            backdrop.addEventListener('mousedown', () => {
                dockState = 'closed'; backdrop.style.display = 'none';
                setTimeout(() => { hitArea.style.pointerEvents = 'auto'; }, 500);
                startLoop();
            });

            window.addEventListener('load', () => {
                cachedW = wrapper.offsetWidth; cachedH = wrapper.offsetHeight;
                initParticles(cachedW, cachedH);
                populateAppGrid();
            });

            const apps = [
                { name: 'Gmail', file: 'gmail.svg', url: 'https://mail.google.com' },
                { name: 'Google', file: 'google.svg', url: 'https://google.com' },
                { name: 'WhatsApp', file: 'Whatsapp.svg', url: 'https://web.whatsapp.com' },
                { name: 'Drive', file: 'drive.svg', url: 'https://drive.google.com' },
                { name: 'Add', file: 'añadir.svg', url: 'action:add' }
            ];

            const populateAppGrid = () => {
                const grid = document.createElement('div');
                grid.className = 'app-grid';
                apps.forEach(app => {
                    const img = document.createElement('img');
                    img.src = `assets/svg/panel_apps/iconos_app/${app.file}`;
                    img.className = 'app-icon'; img.alt = app.name;
                    img.addEventListener('click', () => {
                        if (app.url === 'action:add') console.log('Open Add Modal');
                        else openUrlInSplit(app.url);
                    });
                    grid.appendChild(img);
                });
                document.querySelector('.task-panel-wrapper').appendChild(grid);
            };

            const openUrlInSplit = (url) => {
                if (dockState === 'closed') {
                    dockState = 'open';
                    startLoop(); // Ensure dock reflects state
                }

                const rightPane = document.getElementById('pane-right');
                rightPane.innerHTML = `<webview id="wv-right" src="${url}" style="width:100%; height:100%;" allowpopups useragent="${MODERN_UA}"></webview>`;

                if (splitRatio > 0.9) {
                    animateSplitRatio(0.5);
                } else {
                    updateViewModeState();
                    startLoop();
                }
            };

            const animateSplitRatio = (targetRatio) => {
                splitRatioAnimationActive = true;
                const duration = 500; const startTime = performance.now();
                const startRatio = splitRatio;
                startLoop();
                const step = (now) => {
                    const elapsed = now - startTime;
                    const p = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - p, 3);
                    splitRatio = startRatio + (targetRatio - startRatio) * ease;
                    if (p < 1) requestAnimationFrame(step);
                    else {
                        splitRatio = targetRatio; splitRatioAnimationActive = false;
                        updateViewModeState();
                    }
                };
                requestAnimationFrame(step);
            };

            const updateViewModeState = () => {
                if (splitRatio >= 0.99) { viewMode = 'single-left'; container.classList.remove('splitview-active'); }
                else if (splitRatio <= 0.01) { viewMode = 'single-right'; container.classList.remove('splitview-active'); }
                else { viewMode = 'split'; container.classList.add('splitview-active'); }
            };

            const onMouseMove = (e) => {
                if (!isDragging) return;
                const rect = wrapper.getBoundingClientRect();
                let x = e.clientX - rect.left;
                if (x < 30) x = 0; if (x > rect.width - 30) x = rect.width;
                splitRatio = x / rect.width;
            };

            const onMouseUp = () => {
                isDragging = false; document.body.classList.remove('is-resizing');
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
                updateViewModeState(); startLoop();
            };

            splitDivider.addEventListener('mousedown', (e) => {
                isDragging = true; document.body.classList.add('is-resizing');
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', onMouseUp);
                startLoop(); e.preventDefault();
            });

            const wvLeft = document.getElementById('wv-left');
            wvLeft.addEventListener('did-finish-load', () => console.log('Main webview loaded'));

            // Restore lost dock listeners
            trigger.addEventListener('click', () => {
                container.classList.toggle('container-panel-open');
            });

            splitTrigger.addEventListener('click', () => {
                const paneRight = document.getElementById('pane-right');
                if (!document.getElementById('wv-right')) {
                    const wv = document.createElement('webview');
                    wv.id = 'wv-right';
                    wv.src = 'https://google.com'; // Default
                    wv.setAttribute('allowpopups', '');
                    wv.setAttribute('useragent', MODERN_UA);
                    paneRight.appendChild(wv);
                }
                if (viewMode === 'split') animateSplitRatio(1.0);
                else animateSplitRatio(0.5);
            });

        </script>
    </div>
</body>

</html>